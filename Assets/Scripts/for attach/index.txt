import { render, View, Label, Button } from "onejs-react";
import { useThrottledSync } from "onejs-react";

const pm = CS.UnityEngine.GameObject.Find("InputManager")
const pmInput = pm?.GetComponent("PlayerInputManager")

function App() {
    const hasSelection = useThrottledSync(() => pmInput.HasSelection, 100)
    const mouseX = useThrottledSync(() => pmInput.JS_MouseX, 100)
    const mouseY = useThrottledSync(() => pmInput.JS_MouseY, 100)
    const objType = useThrottledSync(() => pmInput.JS_Obj, 100)
    const gamePhase = useThrottledSync(() => pmInput.GamePhase, 100)
    const isPathBlocked = useThrottledSync(() => pmInput.IsPathBlocked, 100)

    const handlePhaseChange = () => {
        const nextPhase = gamePhase === 0 ? 1 : 0;
        pmInput.SetGamePhase(nextPhase);
        pmInput.HasSelection = false;
    }

    // [ìœ ì§€] ì„ íƒì´ ì—†ì„ ë•Œ: ì¢Œìƒë‹¨ ë²„íŠ¼ë§Œ ê°œë³„ Viewë¡œ ë Œë”ë§
    if (!hasSelection) {
        return (
            <View style={{ position: "absolute", top: 20, left: 20, width: 200 }}>
                <Button onClick={handlePhaseChange} style={{ padding: 20, backgroundColor: gamePhase === 0 ? "#4CAF50" : "#F44336" }}>
                    <Label text={gamePhase === 0 ? "ê±´ì„¤ ëª¨ë“œ" : "ì „íˆ¬ ëª¨ë“œ"} />
                </Button>
            </View>
        )
    }

    // [ìˆ˜ì •] ë²„íŠ¼ í´ë¦­ ì‹œ pmInput.BuildTower ë‚´ë¶€ì—ì„œ HasSelectionì„ falseë¡œ ë§Œë“œë¯€ë¡œ,
    // ë³„ë„ì˜ ì´ë²¤íŠ¸ ì¤‘ë‹¨ í•¨ìˆ˜ ì—†ì´ë„ UIê°€ ì¦‰ì‹œ ì‚¬ë¼ì§€ë©° ê°„ì„­ì„ ìµœì†Œí™”í•©ë‹ˆë‹¤.
    return (
        <>
            <View style={{ position: "absolute", top: 20, left: 20, width: 200 }}>
                <Button onClick={handlePhaseChange} style={{ padding: 20, backgroundColor: gamePhase === 0 ? "#4CAF50" : "#F44336" }}>
                    <Label text={gamePhase === 0 ? "ê±´ì„¤ ëª¨ë“œ" : "ì „íˆ¬ ëª¨ë“œ"} />
                </Button>
            </View>

            {gamePhase === 0 && (
                <>
                    {objType === 0 ? (
                        <>
                            {/* x, y ì¢Œí‘œë¥¼ ê°€ì§„ ê°œë³„ View ë²„íŠ¼ë“¤ */}
                            <MenuButton emoji="ğŸ—ï¸" x={mouseX - 110} y={mouseY - 110} isBlocked={isPathBlocked} 
                                onClick={() => !isPathBlocked &&pmInput.BuildTowerDirect(0)} />
                            <MenuButton emoji="ğŸ’£" x={mouseX + 30} y={mouseY - 110} isBlocked={isPathBlocked}
                                onClick={() => !isPathBlocked &&pmInput.BuildTowerDirect(1)} />
                            <MenuButton emoji="â„¹ï¸" x={mouseX - 110} y={mouseY + 30} isBlocked={isPathBlocked}
                                onClick={() => !isPathBlocked &&pmInput.BuildTowerDirect(2)} />
                            <MenuButton emoji="âŒ" x={mouseX + 30} y={mouseY + 30} isBlocked={isPathBlocked}
                                onClick={() => !isPathBlocked &&pmInput.BuildTowerDirect(3)} />
                        </>
                    ) : (
                        objType > 1 ? ( // 0(ë¹ˆì¹¸), 1(ëª©í‘œ)ì´ ì•„ë‹ ë•Œë§Œ ë…¸ì¶œ
                            <MenuButton emoji="ğŸ—‘ï¸" x={mouseX - 40} y={mouseY - 40} onClick={() => pmInput.RemoveObjectDirect()} />
                        ) : null
                    )}
                </>
            )}
        </>
    )
}

function MenuButton({ emoji, x, y, onClick, isBlocked }: { emoji: string, x: number, y: number, onClick: () => void, isBlocked?: boolean }) {
    return (
        <View style={{ position: "absolute", left: x, top: y, width: 80, height: 80 }}>
            {/* stopPropagation ì—†ì´ ìˆœìˆ˜ onClickë§Œ ì‚¬ìš© */}
            <Button onClick={onClick} style={{
                width: "100%",
                height: "100%",
                backgroundColor: "#222",
                borderWidth: 3,
                borderColor: "white",
                borderRadius: 40,
                justifyContent: "center",
                alignItems: "center",
                opacity: isBlocked ? 0.3 : 1
            }}>
                <Label text={emoji} style={{ fontSize: 32 }} />
            </Button>
        </View>
    )
}

render(<App />, __root)